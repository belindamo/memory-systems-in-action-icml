{
  "turn_global_index": 284,
  "session_index": 28,
  "session_id": "sharegpt_eoJwAWu_4",
  "turn_in_session": 0,
  "date": "2023/05/25 (Thu) 10:13",
  "role": "user",
  "content": "def prepare\\_notification\\_requests(self, request\\_type, notifications):\n \n collection\\_queue = \"default\\_system\\_notification\\_temp\\_queue\"\n \n notification\\_ids = [str(request.get(\"\\_id\")) for request in notifications]\n \n def modify\\_request(request):\n request.update({\"notification\\_id\": str(request.get(\"\\_id\")), \"source\": request\\_type})\n request.pop(\"\\_id\", None)\n return request\n \n def get\\_request\\_update(request):\n return {\n \"timestamp\": datetime.utcnow(),\n 'queued': True\n }\n \n # all non queued notification needs to be updated with timestamp and queue\n updates = [UpdateOne({'queued': False, \"notification\\_id\": str(request.get(\"\\_id\"))},\n {'$set': get\\_request\\_update(request)}) for request in notifications]\n \n upserts = [\n UpdateOne({\"notification\\_id\": str(request.get(\"\\_id\"))}, {'$set': modify\\_request(request)}, upsert=True) for\n request in notifications]\n \n # in case of any new notification created update all notification at once\n writes = updates + upserts\n \n if len(writes) > 0:\n result = self.marketing\\_db\\_handler[collection\\_queue].bulk\\_write(writes)\n self.log\\_upsert\\_results(result)\n \n # in case of new notification update timestamp and null queue status\n update = self.marketing\\_db\\_handler[collection\\_queue].update(\n {\"timestamp\": {\"$eq\": None}, \"queued\": {\"$eq\": None}},\n {\"$set\": {'timestamp': datetime.utcnow(), \"queued\": True}},\n multi=True)\n \n # self.logger.info(\"Update %s \" % (update))\n # deactivate notifications\n update = self.marketing\\_db\\_handler[collection\\_queue].update(\n {\"active\": {'$ne': False}, \"notification\\_id\": {\"$nin\": notification\\_ids}, 'source': request\\_type},\n {\"$set\": {'active': False}}, multi=True)\n------\n1. We are checking for notification in queue\n2. Set all existing notification queue status to True\n3. Upsert notifications which are not created in database\n4. NSet queued true for newly added notifictaions\n5. Deactivate notificatioon which are not in notification\\_ids\n please refractor this code and let us know the possible implementations and incorporate previous results into it",
  "has_answer": false
}