{
  "turn_global_index": 413,
  "session_index": 41,
  "session_id": "sharegpt_EGeZ3gD_0",
  "turn_in_session": 0,
  "date": "2023/05/29 (Mon) 00:00",
  "role": "user",
  "content": "import asyncio\nfrom enum import Enum\nfrom typing import List\nfrom functools import partial\nfrom abc import ABC, abstractmethod\nfrom rich import print\nfrom pydantic import BaseModel, Field # pylint: disable=0611:no-name-in-module\nfrom fastapi import FastAPI, WebSocket, WebSocketDisconnect\nfrom fastapi.responses import HTMLResponse\nimport uvicorn\nfrom td.client import TdAmeritradeClient\nfrom td.config import TdConfiguration\nfrom td.enums.enums import QOSLevel, TimesaleServices\nfrom td.utils.helpers import to\\_camel\n\nclass StreamBase(BaseModel):\n class Config:\n alias\\_generator = to\\_camel\n allow\\_population\\_by\\_field\\_name = True\n\nclass DataResponseContent(StreamBase):\n pass\n\nclass DataResponseMessage(StreamBase):\n service: str\n timestamp: int\n command: str\n content: List[DataResponseContent]\n\nclass TimesaleData(DataResponseContent):\n symbol: str = Field(alias=\"key\")\n timestamp: int = Field(alias=\"1\")\n price: float = Field(alias=\"2\")\n volume: int = Field(alias=\"3\")\n bid\\_size: int = Field(alias=\"4\")\n seq: int | None = None\n\nclass ChartData(DataResponseContent):\n symbol: str = Field(alias=\"key\")\n timestamp: int = Field(alias=\"1\")\n open: float = Field(alias=\"2\")\n high: float = Field(alias=\"3\")\n low: float = Field(alias=\"4\")\n close: float = Field(alias=\"5\")\n volume: int = Field(alias=\"6\")\n seq: int | None = None\n\nclass DataMessageHandler(ABC):\n def \\_\\_init\\_\\_(self, model):\n self.model = model\n self.latest\\_data = None\n self.subscribers = []\n \n async def data\\_message\\_handler(self, msg):\n msg[\"content\"] = [self.model(\\*\\*data) for data in msg[\"content\"]]\n self.latest\\_data = DataResponseMessage(\\*\\*msg)\n await self.\\_send\\_to\\_subscribers(self.latest\\_data)\n\n async def subscribe(self, websocket):\n if self.latest\\_data:\n await websocket.send\\_json(self.latest\\_data.dict())\n self.subscribers.append(websocket)\n\n async def unsubscribe(self, websocket):\n self.subscribers.remove(websocket)\n\n async def \\_send\\_to\\_subscribers(self, data):\n for ws in self.subscribers:\n await ws.send\\_json(data.dict())\n\n # @abstractmethod\n # async def handle\\_message(self, msg):\n # pass\n\nclass TimesaleDataHandler(DataMessageHandler):\n pass\n\nclass ChartDataHandler(DataMessageHandler):\n pass\n\ntimesale\\_handler = TimesaleDataHandler(TimesaleData)\nchart\\_handler = ChartDataHandler(ChartData)\n\napp = FastAPI()\n\n@app.websocket(\"/ws/{handler\\_name}\")\nasync def websocket\\_endpoint(websocket: WebSocket, handler\\_name: str):\n await websocket.accept()\n handler\\_map = {\"timesale\": timesale\\_handler, \"chart\": chart\\_handler}\n handler = handler\\_map.get(handler\\_name)\n if handler:\n try:\n while True:\n message = await websocket.receive\\_json()\n if message['command'] == 'subscribe':\n await handler.subscribe(websocket)\n elif message['command'] == 'unsubscribe':\n await handler.unsubscribe(websocket)\n break # Stop handling messages after unsubscribing\n except WebSocketDisconnect:\n await handler.unsubscribe(websocket)\n else:\n await websocket.close()\n# Define a route to serve the HTML page that opens the WebSocket connection.\n@app.get(\"/\")\nasync def get():\n return HTMLResponse(\"\"\"\n \n \n WebSocket Test\n \n \n \n \n \n \"\"\")\n\nasync def run\\_uvicorn():\n uvicorn\\_config = uvicorn.Config(app, host=\"127.0.0.1\", port=8000)\n uvicorn\\_server = uvicorn.Server(uvicorn\\_config)\n await uvicorn\\_server.serve()\nconfig = TdConfiguration()\ntd\\_client = TdAmeritradeClient()\nstream\\_client = td\\_client.streaming\\_api\\_client()\nstream\\_services = stream\\_client.services()\n\nasync def run\\_stream\\_client():\n # Start the app with uvicorn and the uvloop event loop policy.\n # uvicorn.run(app, host=\"localhost\", port=8000, loop=loop)\n stream\\_client.open\\_stream()\n\n # Set the Quality of Service.\n stream\\_services.quality\\_of\\_service(\n qos\\_level=QOSLevel.EXPRESS\n )\n\n futures\\_symbols = [\"/ES\", \"/NQ\"]\n equity\\_symbols = [\"SPY\", \"QQQ\", \"AAPL\", \"TSLA\"]\n\n # Start streaming data\n stream\\_services.add\\_handler(\"data\", \"TIMESALE\\_FUTURES\", timesale\\_handler.data\\_message\\_handler)\n stream\\_services.futures\\_timesale(futures\\_symbols)\n\n stream\\_services.add\\_handler(\"data\", \"CHART\\_FUTURES\", chart\\_handler.data\\_message\\_handler)\n stream\\_services.futures\\_chart\\_minute\\_ohlcv(futures\\_symbols)\n\n stream\\_services.add\\_handler(\"data\", \"CHART\\_EQUITY\", chart\\_handler.data\\_message\\_handler)\n stream\\_services.equity\\_chart\\_minute\\_ohlcv(equity\\_symbols)\n\nasync def run\\_app():\n # create tasks for run\\_uvicorn and run\\_stream\\_client\n uvicorn\\_task = asyncio.create\\_task(run\\_uvicorn())\n stream\\_client\\_task = asyncio.create\\_task(run\\_stream\\_client())\n\n # wait for both tasks to complete\n await asyncio.gather(uvicorn\\_task, stream\\_client\\_task)\n\nif \\_\\_name\\_\\_ == '\\_\\_main\\_\\_':\n # Run the app in the event loop.\n asyncio.run(run\\_app())\n\nmake this error go away\n\nTraceback (most recent call last):\n File \"c:\\Users\\zachf\\OneDrive\\Desktop\\benjamins\\td-ameritrade-api\\samples\\use\\_streaming\\_client.py\", line 94, in websocket\\_endpoint\n message = await websocket.receive\\_json()\n File \"C:\\Users\\zachf\\anaconda3\\envs\\lucca-data\\lib\\site-packages\\starlette\\websockets.py\", line 133, in receive\\_json\n self.\\_raise\\_on\\_disconnect(message)\n File \"C:\\Users\\zachf\\anaconda3\\envs\\lucca-data\\lib\\site-packages\\starlette\\websockets.py\", line 105, in \\_raise\\_on\\_disconnect\n raise WebSocketDisconnect(message[\"code\"])\nstarlette.websockets.WebSocketDisconnect: 1001\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback (most recent call last):\n File \"C:\\Users\\zachf\\anaconda3\\envs\\lucca-data\\lib\\site-packages\\uvicorn\\protocols\\websockets\\websockets\\_impl.py\", line 254, in run\\_asgi\n result = await self.app(self.scope, self.asgi\\_receive, self.asgi\\_send)\n File \"C:\\Users\\zachf\\anaconda3\\envs\\lucca-data\\lib\\site-packages\\uvicorn\\middleware\\proxy\\_headers.py\", line 78, in \\_\\_call\\_\\_\n return await self.app(scope, receive, send)\n File \"C:\\Users\\zachf\\anaconda3\\envs\\lucca-data\\lib\\site-packages\\fastapi\\applications.py\", line 276, in \\_\\_call\\_\\_\n await super().\\_\\_call\\_\\_(scope, receive, send)\n File \"C:\\Users\\zachf\\anaconda3\\envs\\lucca-data\\lib\\site-packages\\starlette\\applications.py\", line 122, in \\_\\_call\\_\\_\n await self.middleware\\_stack(scope, receive, send)\n File \"C:\\Users\\zachf\\anaconda3\\envs\\lucca-data\\lib\\site-packages\\starlette\\middleware\\errors.py\", line 149, in \\_\\_call\\_\\_\n await self.app(scope, receive, send)\n File \"C:\\Users\\zachf\\anaconda3\\envs\\lucca-data\\lib\\site-packages\\starlette\\middleware\\exceptions.py\", line 79, in \\_\\_call\\_\\_\n raise exc\n File \"C:\\Users\\zachf\\anaconda3\\envs\\lucca-data\\lib\\site-packages\\starlette\\middleware\\exceptions.py\", line 68, in \\_\\_call\\_\\_\n await self.app(scope, receive, sender)\n File \"C:\\Users\\zachf\\anaconda3\\envs\\lucca-data\\lib\\site-packages\\fastapi\\middleware\\asyncexitstack.py\", line 21, in \\_\\_call\\_\\_\n raise e\n File \"C:\\Users\\zachf\\anaconda3\\envs\\lucca-data\\lib\\site-packages\\fastapi\\middleware\\asyncexitstack.py\", line 18, in \\_\\_call\\_\\_\n await self.app(scope, receive, send)\n File \"C:\\Users\\zachf\\anaconda3\\envs\\lucca-data\\lib\\site-packages\\starlette\\routing.py\", line 718, in \\_\\_call\\_\\_\n await route.handle(scope, receive, send)\n File \"C:\\Users\\zachf\\anaconda3\\envs\\lucca-data\\lib\\site-packages\\starlette\\routing.py\", line 341, in handle\n await self.app(scope, receive, send)\n File \"C:\\Users\\zachf\\anaconda3\\envs\\lucca-data\\lib\\site-packages\\starlette\\routing.py\", line 82, in app\n await func(session)\n File \"C:\\Users\\zachf\\anaconda3\\envs\\lucca-data\\lib\\site-packages\\fastapi\\routing.py\", line 289, in app\n await dependant.call(\\*\\*values)\n File \"c:\\Users\\zachf\\OneDrive\\Desktop\\benjamins\\td-ameritrade-api\\samples\\use\\_streaming\\_client.py\", line 101, in websocket\\_endpoint\n await handler.unsubscribe(websocket)\n File \"c:\\Users\\zachf\\OneDrive\\Desktop\\benjamins\\td-ameritrade-api\\samples\\use\\_streaming\\_client.py\", line 65, in unsubscribe\n self.subscribers.remove(websocket)\nValueError: list.remove(x): x not in list\nINFO: connection closed\nINFO: ('127.0.0.1', 51918) - \"WebSocket /ws/chart\" [accepted]\nINFO: connection open",
  "has_answer": false
}