{
  "turn_global_index": 368,
  "session_index": 34,
  "session_id": "sharegpt_fVujVyX_5",
  "turn_in_session": 2,
  "date": "2023/05/23 (Tue) 12:03",
  "role": "assistant",
  "content": "Sure! Here's an updated Ansible playbook that uses an inventory and roles to improve organization and security:\n\nFirst, let's create an inventory file named `inventory.ini` with the following content:\n```css\n[k8s-cluster]\nk8s-master ansible_host=172.28.128.10\nk8s-node1 ansible_host=172.28.128.11\n\n[k8s-cluster:vars]\nansible_user=ubuntu\nansible_ssh_private_key_file=/path/to/ssh/key\n```\nThis inventory specifies the hosts in our cluster (`k8s-master` and `k8s-node1`) along with their IP addresses and SSH connection details.\n\nNext, let's create the following directory structure in our Ansible project directory:\n```css\nansible-project/\n\u251c\u2500\u2500 inventory.ini\n\u251c\u2500\u2500 roles/\n\u2502   \u251c\u2500\u2500 base/\n\u2502   \u2502   \u251c\u2500\u2500 tasks/\n\u2502   \u2502   \u2502   \u2514\u2500\u2500 main.yml\n\u2502   \u2502   \u2514\u2500\u2500 vars/\n\u2502   \u2502       \u2514\u2500\u2500 main.yml\n\u2502   \u251c\u2500\u2500 kubernetes/\n\u2502   \u2502   \u251c\u2500\u2500 tasks/\n\u2502   \u2502   \u2502   \u2514\u2500\u2500 main.yml\n\u2502   \u2502   \u2514\u2500\u2500 vars/\n\u2502   \u2502       \u2514\u2500\u2500 main.yml\n\u2502   \u2514\u2500\u2500 security/\n\u2502       \u251c\u2500\u2500 tasks/\n\u2502       \u2502   \u2514\u2500\u2500 main.yml\n\u2502       \u2514\u2500\u2500 vars/\n\u2502           \u2514\u2500\u2500 main.yml\n\u2514\u2500\u2500 site.yml\n```\n* `inventory.ini`: our inventory file containing the hosts and their connection details.\n* `roles/`: a directory containing our roles.\n* `roles/base/`: a role that installs basic system packages and sets up the firewall rules.\n* `roles/kubernetes/`: a role that installs and configures Kubernetes.\n* `roles/security/`: a role that applies security configurations.\n* `site.yml`: our main playbook that uses the roles.\n\nNow, let's define the tasks for each role.\n\nIn `roles/base/tasks/main.yml`, add the following content:\n```yaml\n---\n- name: Install basic packages\n  apt:\n    name: \"{{ item }}\"\n    state: present\n  loop:\n    - curl\n    - apt-transport-https\n    - wget\n    - vim\n    - git\n\n- name: Set up firewall\n  ufw:\n    rule: allow\n    name: OpenSSH\n    state: enabled\n```\nThis role installs basic packages and sets up the firewall to allow SSH connections.\n\nIn `roles/kubernetes/tasks/main.yml`, add the following content:\n```yaml\n---\n- name: Add Kubernetes GPG key\n  apt_key:\n    url: https://packages.cloud.google.com/apt/doc/apt-key.gpg\n    state: present\n\n- name: Add Kubernetes repository\n  apt_repository:\n    repo: deb https://apt.kubernetes.io/ kubernetes-xenial main\n    state: present\n    filename: kubernetes\n\n- name: Install Kubernetes packages\n  apt:\n    name:\n      - kubelet\n      - kubeadm\n      - kubectl\n    state: present\n\n- name: Hold Kubernetes packages at current version\n  apt:\n    name:\n      - kubelet\n      - kubeadm\n      - kubectl\n    state: held\n\n- name: Disable swap\n  command: swapoff -a\n\n- name: Add kernel modules\n  command: modprobe {{ item }}\n  loop:\n    - overlay\n    - br_netfilter\n\n- name: Add sysctl settings\n  copy:\n    content: |\n      net.bridge.bridge-nf-call-ip6tables = 1\n      net.bridge.bridge-nf-call-iptables = 1\n      net.ipv4.ip_forward = 1\n    dest: /\n```",
  "has_answer": false
}