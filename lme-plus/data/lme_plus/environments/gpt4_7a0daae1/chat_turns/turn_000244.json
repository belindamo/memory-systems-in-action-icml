{
  "turn_global_index": 244,
  "session_index": 26,
  "session_id": "sharegpt_MyxBntK_25",
  "turn_in_session": 4,
  "date": "2023/03/17 (Fri) 16:08",
  "role": "assistant",
  "content": "Sure, here's the updated script with an additional check to ensure that the original file was renamed before uploading the new file:\n```python\nimport os\nimport base64\nimport requests\nimport yaml\n\n# Input parameters\norg = \"drulacosmin\"\nrepo_names = [\"repo1\", \"repo2\"]\nfile_path = \".github/workflows/google.yml\"\naccess_token = \"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\"\nreplace_string = \"workflows-testing\"\nbranch_name = \"main\"\n\n# Set the API endpoint and headers\napi_url = \"https://api.github.com\"\nheaders = {\n    \"Accept\": \"application/vnd.github+json\",\n    \"Authorization\": f\"Bearer {access_token}\",\n    \"Content-Type\": \"application/json\",\n    \"User-Agent\": \"python\"\n}\n\n# Loop over the repo_names list and modify the YAML file in each repository\nfor repo_name in repo_names:\n    # Get the repository object\n    repo_url = f\"{api_url}/repos/{org}/{repo_name}\"\n    repo_res = requests.get(repo_url, headers=headers)\n    repo_res.raise_for_status()\n    repo = repo_res.json()\n    print(f\"Repository(full_name=\\\"{repo['full_name']}\\\")\")\n\n    # Get the branch object\n    branch_url = f\"{api_url}/repos/{org}/{repo_name}/branches/{branch_name}\"\n    branch_res = requests.get(branch_url, headers=headers)\n    branch_res.raise_for_status()\n    branch = branch_res.json()\n\n    # Get the file content from the repository\n    file_url = f\"{api_url}/repos/{org}/{repo_name}/contents/{file_path}?ref={branch_name}\"\n    file_res = requests.get(file_url, headers=headers)\n    file_res.raise_for_status()\n    file_content = base64.b64decode(file_res.json()[\"content\"]).decode(\"utf-8\")\n\n    # Create a temporary directory\n    temp_dir = 'TEMP_folder'\n    if not os.path.exists(temp_dir):\n        os.mkdir(temp_dir)\n\n    # Create a temporary file in the directory\n    temp_file_path = os.path.join(temp_dir, os.path.basename(file_path))\n    with open(temp_file_path, 'w') as f:\n        f.write(file_content)\n\n    # Modify the YAML file content\n    os.system(f\"yq e '.on.push.branches = [\\\"Build and Release\\\"]' -i {temp_file_path}\")\n\n    # Get the modified file content\n    with open(temp_file_path, 'r') as f:\n        modified_file_content = f.read()\n\n    # Check if the original file was renamed\n    if os.path.exists(f\"{file_path}_OLD\"):\n        os.remove(file_path)\n        os.rename(f\"{file_path}_OLD\", file_path)\n    else:\n        print(f\"Error: {file_path}_OLD does not exist\")\n        continue\n\n    # Save the modified file with the original name\n    with open(file_path, 'w') as f:\n        f.write(modified_file_content)\n\n    # Upload the modified file to the repository\n    commit_message = f\"Add {file_path} with Build and Release branch\"\n    update_url = f\"{api_url}/repos/{org}/{repo_name}/contents/{file_path}\"\n    update_res = requests.put(update_url, headers=headers, json={\n        \"message\": commit_message,\n        \"content\": base64.b64encode(modified_file_content.encode()).decode(),\n        \"branch\": branch_name,\n        \"sha\": file_res.json()[\"sha\"]\n    })\n    update_res.raise_for_status()\n    print(\"Workflow file updated\")\n\n    # Remove the temporary file and directory\n    os\n```",
  "has_answer": false
}