{
  "turn_global_index": 142,
  "session_index": 16,
  "session_id": "sharegpt_fVujVyX_5",
  "turn_in_session": 4,
  "date": "2023/05/23 (Tue) 07:14",
  "role": "assistant",
  "content": "Sure! Here's an updated Ansible playbook that uses an inventory file and roles to improve organization and security:\n\n**inventory.ini:**\n```makefile\n[kubernetes]\nk8s-master ansible_host=172.28.128.10\nk8s-node1 ansible_host=172.28.128.11\n\n[kubernetes:vars]\nansible_ssh_user=<your_ssh_user>\nansible_ssh_private_key_file=<path_to_your_private_key>\n```\n**playbook.yml:**\n```yaml\n- hosts: kubernetes\n  become: yes\n\n  roles:\n    - common\n    - k8s\n\n  tasks:\n    - name: Verify that a reboot is not required\n      stat:\n        path: /var/run/reboot-required\n      register: reboot_required\n      ignore_errors: yes\n\n    - name: Reboot the servers if necessary\n      command: shutdown -r now \"Rebooting due to package updates\" creates=/var/run/reboot-required\n      when: reboot_required.stat.exists\n      async: 0\n      poll: 0\n      ignore_errors: yes\n```\n**roles/common/tasks/main.yml:**\n```yaml\n- name: Update apt cache\n  apt:\n    update_cache: yes\n\n- name: Upgrade all packages\n  apt:\n    upgrade: dist\n    autoremove: yes\n\n- name: Install required packages\n  apt:\n    name:\n      - curl\n      - apt-transport-https\n    state: present\n```\n**roles/k8s/tasks/main.yml:**\n```yaml\n- name: Add Kubernetes APT key\n  apt_key:\n    url: https://packages.cloud.google.com/apt/doc/apt-key.gpg\n    state: present\n\n- name: Add Kubernetes APT repository\n  apt_repository:\n    repo: deb https://apt.kubernetes.io/ kubernetes-xenial main\n    state: present\n    filename: kubernetes.list\n\n- name: Install Kubernetes packages\n  apt:\n    name:\n      - kubelet\n      - kubeadm\n      - kubectl\n    state: present\n\n- name: Mark Kubernetes packages as held back\n  apt:\n    name:\n      - kubelet\n      - kubeadm\n      - kubectl\n    state: hold\n\n- name: Turn off swap\n  command: swapoff -a\n\n- name: Disable swap in /etc/fstab\n  lineinfile:\n    path: /etc/fstab\n    regexp: '^/swapfile'\n    state: absent\n    backup: yes\n  become: yes\n\n- name: Enable kernel modules\n  modprobe:\n    name:\n      - overlay\n      - br_netfilter\n\n- name: Add kernel settings\n  sysctl:\n    name: \"{{ item }}\"\n    value: \"{{ k8s_sysctl_settings[item] }}\"\n    state: present\n    sysctl_file: /etc/sysctl.d/kubernetes.conf\n  with_items: \"{{ k8s_sysctl_settings.keys() }}\"\n  become: yes\n\n- name: Reload sysctl\n  command: sysctl --system\n```\n**roles/k8s/vars/main.yml:**\n```yaml\nk8s_sysctl_settings:\n  net.bridge.bridge-nf-call-ip6tables: 1\n  net.bridge.bridge-nf-call-iptables: 1\n  net.ipv4.ip_forward: 1\n```\nYou can adjust the variables and configuration files to fit your specific needs. Make sure to replace the variables in the inventory file with your own values, and update the SSH user and private key file path in the inventory variables section.\n\nThis playbook also includes a task to reboot the servers if necessary after the updates, as well as some security improvements such as disabling swap",
  "has_answer": false
}