{
  "turn_global_index": 41,
  "session_index": 3,
  "session_id": "sharegpt_5jHUxvs_80",
  "turn_in_session": 3,
  "date": "2023/03/24 (Fri) 09:14",
  "role": "assistant",
  "content": "I apologize for the inconvenience. It seems the issue is with the `$domainAdminUsername` variable not being passed correctly to the script running on the VM. Let's try a different approach by directly using the pipeline variables instead of setting environment variables.\n\nUpdate the script as follows:\n```yaml\nsteps:\n- task: AzureKeyVault@2\n  inputs:\n    connectedServiceName: 'DC-Project-SC'\n    keyVaultName: 'Terraform-DC-KV'\n    secretsFilter: 'intro,outro'\n  name: FetchSecrets\n\n- task: AzureCLI@2\n  inputs:\n    azureSubscription: 'DC-Project-SC'\n    scriptType: 'pscore'\n    scriptLocation: 'inlineScript'\n    inlineScript: |\n      # Set variables\n      $domainAdminUsername = \"$(intro)\"\n      $domainAdminPassword = \"$(outro)\"\n      $domain = 'corp.nmrp.com'\n      $ou = 'OU=computers,DC=corp,DC=nmrp,DC=com'\n      $vmName = 'demo-vm-NICK'\n      $resourceGroupName = 'devops-test' # Replace with a variable or parameter if needed\n\n      # Get VM\n      $vm = az vm show --name $vmName --resource-group $resourceGroupName | ConvertFrom-Json\n\n      # Update VM operating system and join domain\n      $joinDomainScript = @'\n      $domainAdminUsername = \"{0}\"\n      $domainAdminPassword = ConvertTo-SecureString \"{1}\" -AsPlainText -Force\n      Add-Computer -DomainName {2} -OUPath {3} -Credential (New-Object System.Management.Automation.PSCredential($domainAdminUsername, $domainAdminPassword)) -Restart\n      '@ -f $domainAdminUsername, $domainAdminPassword, $domain, $ou\n\n      # Encode the script in Base64\n      $joinDomainScriptBase64 = [Convert]::ToBase64String([System.Text.Encoding]::Unicode.GetBytes($joinDomainScript))\n\n      # Execute script on VM\n      $vmResourceId = $vm.id\n      az vm run-command invoke --ids $vmResourceId --command-id 'RunPowerShellScript' --scripts \"powershell -EncodedCommand $joinDomainScriptBase64\"\n    displayName: 'Join VM to Domain'\n```\nIn this version of the script, I removed the environment variable assignment and directly used the pipeline variables `$(intro)` and `$(outro)` as the values of `$domainAdminUsername` and `$domainAdminPassword`. This should resolve the issue with the \"userName\" argument.",
  "has_answer": false
}