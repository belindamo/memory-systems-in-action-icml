{
  "turn_global_index": 158,
  "session_index": 14,
  "session_id": "sharegpt_14s18aO_178",
  "turn_in_session": 0,
  "date": "2023/06/28 (Wed) 16:37",
  "role": "user",
  "content": "following code not working while it comes to stock is available\n\npublic function product\\_search(WP\\_REST\\_Request $request)\n {\n $search = $request->get\\_param('search');\n $min\\_price = $request->get\\_param('min\\_price');\n $max\\_price = $request->get\\_param('max\\_price');\n $stock = $request->get\\_param('stock');\n $color = $request->get\\_param('color');\n $size = $request->get\\_param('size');\n $orderby = $request->get\\_param('orderby');\n $brand = $request->get\\_param('brand');\n $sale = $request->get\\_param('sale');\n $cat\\_ids = $request->get\\_param('cat\\_ids');\n $paged = ($request->get\\_param('paged')) ? $request->get\\_param('paged') : 1;\n\n $args = [\n 'post\\_type' => 'product',\n 'post\\_status' => 'publish',\n 'posts\\_per\\_page' => 12,\n 'paged' => $paged,\n 'fields' => 'ids',\n 'meta\\_query' => [\n 'relation' => 'AND',\n ]\n ];\n if ($min\\_price and $max\\_price) {\n $args['meta\\_query'][] = [\n 'key' => '\\_price',\n 'value' => [$min\\_price, $max\\_price],\n 'compare' => 'BETWEEN',\n 'type' => 'numeric',\n ];\n } elseif ($min\\_price) {\n $args['meta\\_query'][] = [\n 'key' => '\\_price',\n 'value' => $min\\_price,\n 'compare' => '>=',\n 'type' => 'NUMERIC'\n ];\n } elseif ($max\\_price) {\n $args['meta\\_query'][] = [\n 'key' => '\\_price',\n 'value' => $min\\_price,\n 'compare' => '<=',\n 'type' => 'NUMERIC'\n ];\n }\n if ($sale) {\n $args['meta\\_query'][] = [\n 'key' => '\\_sale\\_price',\n 'value' => 0,\n 'compare' => '>',\n 'type' => 'numeric'\n ];\n }\n if (true) {\n $args['meta\\_query'][] = [\n 'key' => '\\_stock',\n 'value' => 0,\n 'compare' => '>',\n ];\n }\n if ($size) {\n $args['tax\\_query'][] = [\n 'taxonomy' => 'pa\\_size',\n 'field' => 'slug',\n 'terms' => is\\_array($size) ? $size : [$size],\n 'operator' => 'IN',\n ];\n }\n if ($brand) {\n $args['tax\\_query'][] = [\n 'taxonomy' => 'pa\\_brand',\n 'field' => 'slug',\n 'terms' => is\\_array($brand) ? $brand : [$brand],\n 'operator' => 'IN',\n ];\n }\n if ($color) {\n $args['tax\\_query'][] = [\n 'taxonomy' => 'pa\\_color',\n 'field' => 'slug',\n 'terms' => is\\_array($color) ? $color : [$color],\n 'operator' => 'IN',\n ];\n }\n if ($cat\\_ids) {\n $args['tax\\_query'][] = [\n 'taxonomy' => 'product\\_cat',\n 'field' => 'id',\n 'terms' => is\\_array($cat\\_ids) ? $cat\\_ids : [$cat\\_ids],\n 'operator' => 'IN',\n ];\n }\n\n if ($orderby) {\n $args['orderby'] = 'meta\\_value\\_num';\n }\n if ($orderby == 'price\\_asc') {\n $args['order'] = 'asc';\n $args['meta\\_key'] = '\\_price';\n } elseif ($orderby == 'price\\_desc') {\n $args['order'] = 'desc';\n $args['meta\\_key'] = '\\_price';\n } elseif ($orderby == 'rating') {\n $args['order'] = 'desc';\n $args['meta\\_key'] = '\\_wc\\_average\\_rating';\n } elseif ($orderby == 'popularity') {\n $args['order'] = 'desc';\n $args['meta\\_key'] = 'total\\_sales';\n } else {\n $args['orderby'] = 'publish\\_date';\n $args['order'] = 'desc';\n }\n\n if ($search) {\n $args['s'] = $search;\n \n }\n \n $query = new WP\\_Query($args);\n \n $products = [];\n foreach ($query->get\\_posts() as $key => $id) {\n $products[] = display\\_sample\\_products($id, $this->user\\_id);\n }\n if($search and !$products){\n unset($args['s']);\n $args['meta\\_query'][]=[\n 'key' => '\\_sku',\n 'value' => $search,\n 'compare' => 'LIKE'\n\n ];\n\n }\n $query = new WP\\_Query($args);\n\n foreach ($query->get\\_posts() as $key => $id) {\n $products[] = display\\_sample\\_products($id, $this->user\\_id);\n }\n\n $args['posts\\_per\\_page'] = -1;\n $query2 = new WP\\_Query($args);\n $ids = $query2->get\\_posts();\n $attribute = [];\n $attribute['brand'] = wp\\_get\\_object\\_terms($ids, 'pa\\_brand');\n $attribute['color'] = wp\\_get\\_object\\_terms($ids, 'pa\\_color');\n $attribute['size'] = wp\\_get\\_object\\_terms($ids, 'pa\\_size');\n\n return ['products' => $products, 'attribute' => $attribute];\n }",
  "has_answer": false
}